<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</title>
<link rel="stylesheet" href="style.css">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f1418">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside id="sidebar" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <div class="brand">üì∞ –ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</div>
      <div style="color:#999">–ó–∞—Ä–µ–∂–¥–∞–º –º–µ–Ω—é...</div>
    </aside>

    <main>
      <!-- Pull-to-refresh -->
      <div id="ptr" aria-hidden="true">
        <div class="ptr-inner">
          <span class="ptr-icon">‚Üì</span>
          <span class="ptr-text">–ò–∑—Ç–µ–≥–ª–∏ –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ</span>
        </div>
      </div>

      <!-- Top bar -->
      <div class="top">
        <button id="menuToggle" class="icon-btn" aria-label="–û—Ç–≤–æ—Ä–∏ –º–µ–Ω—é">‚ò∞</button>

        <div class="import-actions">
          <label class="btn file-btn">
            –ö–∞—á–∏ .html
            <input id="fileInput" type="file" accept=".html,.htm,text/html" hidden>
          </label>
          <button id="btnPaste" class="btn">–ü–æ—Å—Ç–∞–≤–∏ HTML</button>
        </div>
      </div>

      <div id="status" class="status"></div>

      <!-- Filters -->
      <section class="filters">
        <div class="time-filters scroller">
          <button class="chip" data-filter="today">–î–Ω–µ—Å</button>
          <button class="chip" data-filter="week">–¢–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞</button>
          <button class="chip" data-filter="month">–¢–æ–∑–∏ –º–µ—Å–µ—Ü</button>
          <button class="chip active" data-filter="all">–í—Å–∏—á–∫–∏</button>
        </div>
        <div class="category-filter">
          <label for="categorySelect" class="cat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
          <select id="categorySelect">
            <option value="all">–í—Å–∏—á–∫–∏</option>
          </select>
        </div>
      </section>

      <!-- News list -->
      <div id="list" class="list">
        <div class="placeholder">
          –ò–∑–ø–æ–ª–∑–≤–∞–π <b>–º–µ–Ω—é—Ç–æ</b> –∏–ª–∏ <b>–ö–∞—á–∏ HTML</b>. –©–µ —Å–µ –∏–∑–≤–ª–µ—á–µ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.
        </div>
      </div>
    </main>
  </div>

  <!-- Reader -->
  <div id="reader" class="reader" style="display:none" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="reader-backdrop"></div>
    <div class="reader-panel">
      <div class="reader-bar">
        <div class="reader-title">–ß–µ—Ç–µ—Ü</div>
        <div class="reader-actions">
          <button id="readerClose" class="btn">–ó–∞—Ç–≤–æ—Ä–∏</button>
        </div>
      </div>
      <div id="readerContent" class="reader-content"></div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const statusEl = $('#status'), listEl = $('#list'), sidebarEl = $('#sidebar');
function setStatus(msg){ statusEl.textContent = msg || ''; }
function clearList(){ listEl.innerHTML=''; }
function placeholder(msg){ const d=document.createElement('div'); d.className='placeholder'; d.innerHTML=msg; listEl.appendChild(d); }
function parseHTML(html){ return new DOMParser().parseFromString(html,'text/html'); }
function absURL(base, rel){ try{ return new URL(rel, base).href }catch{ return rel } }
function sanitize(node){ node.querySelectorAll('script,style,iframe,object,embed,noscript').forEach(n=>n.remove()); return node; }
function fixRelativeURLs(node, baseHref){
  node.querySelectorAll('[href]').forEach(a=> a.setAttribute('href', absURL(baseHref, a.getAttribute('href'))));
  node.querySelectorAll('[src]').forEach(el=> el.setAttribute('src', absURL(baseHref, el.getAttribute('src'))));
  return node;
}

function selectRawBlocks(doc){
  return Array.from(doc.querySelectorAll('div.card.pt-4.pb-4.ad0, div.card.pt-4.pb-4.ad3'));
}

function toCardElement(rawHTML, baseHref){
  const fragDoc = parseHTML('<div id="wrap">'+rawHTML+'</div>');
  const wrap = fragDoc.getElementById('wrap');
  sanitize(wrap);
  fixRelativeURLs(wrap, baseHref);

  let imgSrc = wrap.querySelector('img')?.src || null;
  let title = wrap.querySelector('h1,h2,h3')?.innerText?.trim() || '';
  let link = wrap.querySelector('a[href]')?.getAttribute('href') || '';
  let dateText = wrap.querySelector('time[datetime]')?.getAttribute('datetime') || '';
  let formattedDate = '';
  if(dateText){ const d = new Date(dateText); if(!isNaN(d)) formattedDate = d.toLocaleString('bg-BG',{dateStyle:'medium'}); }

  const breadcrumb = wrap.querySelector('li.breadcrumb-item.d-lg-inline.mb-1');
  const category = breadcrumb ? breadcrumb.textContent.trim() : '';

  const card = document.createElement('div');
  card.className='card-row';
  if(dateText) card.dataset.date = dateText;
  if(category) card.dataset.category = category;

  card.innerHTML = `
    <div class="thumb">${imgSrc?`<img src="${imgSrc}" alt="">`:'<span>no image</span>'}</div>
    <div class="right-side">
      <div class="header-row">
        <h3 class="title"><a href="#">${title}</a></h3>
        ${formattedDate?`<div class="meta-date">üïí ${formattedDate}</div>`:''}
      </div>
      <div class="meta">${category?`–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}`:''}</div>
    </div>`;
  card.querySelector('a').addEventListener('click', e=>{ e.preventDefault(); openReader(link); });
  return card;
}

async function importURL(url){
  if(!url){ setStatus('–ù—è–º–∞ URL.'); return; }
  setStatus('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ...');
  try{
    const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
    const html = await res.text();
    const doc = parseHTML(html);
    renderCardsFromDoc(doc, url);
    setStatus('‚úÖ –ì–æ—Ç–æ–≤–æ.');
  }catch(e){ setStatus('‚ùå –ì—Ä–µ—à–∫–∞: '+e.message); }
}

function renderCardsFromDoc(doc, baseHref){
  const raw = selectRawBlocks(doc);
  clearList();
  if(!raw.length){ placeholder('–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –µ–ª–µ–º–µ–Ω—Ç–∏.'); return; }
  raw.forEach(node => listEl.appendChild(toCardElement(node.outerHTML, baseHref)));
  populateCategories();
}

// Sidebar
async function loadSidebar(){
  try{
    const html = await fetch('sidebar.html').then(r=>r.text());
    sidebarEl.innerHTML = html;
    sidebarEl.addEventListener('click', e=>{
      const target = e.target.closest('[data-url]');
      if(!target) return;
      e.preventDefault();
      importURL(target.getAttribute('data-url'));
      document.body.classList.remove('sidebar-open');
    });
  }catch{ sidebarEl.innerHTML='<div class="placeholder">‚ùå –ù–µ —É—Å–ø—è—Ö –¥–∞ –∑–∞—Ä–µ–¥—è sidebar.html</div>'; }
}
loadSidebar();

$('#menuToggle').addEventListener('click',()=>document.body.classList.toggle('sidebar-open'));
document.addEventListener('click',e=>{
  if(document.body.classList.contains('sidebar-open')){
    if(!$('#sidebar').contains(e.target)&&!$('#menuToggle').contains(e.target))
      document.body.classList.remove('sidebar-open');
  }
});

// File + Paste
$('#fileInput').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f)return;
  const html=await f.text(); renderCardsFromDoc(parseHTML(html),'file:///'+f.name);
  setStatus('‚úÖ –ö–∞—á–µ–Ω —Ñ–∞–π–ª.'); e.target.value='';
});
$('#btnPaste').addEventListener('click',async()=>{
  try{
    const text=await navigator.clipboard.readText();
    if(!text.includes('<'))return setStatus('–ë—É—Ñ–µ—Ä—ä—Ç –Ω–µ —Å—ä–¥—ä—Ä–∂–∞ HTML.');
    renderCardsFromDoc(parseHTML(text),location.href);
    setStatus('‚úÖ –ü–æ—Å—Ç–∞–≤–µ–Ω HTML.');
  }catch(e){setStatus('‚ùå –ì—Ä–µ—à–∫–∞: '+e.message);}
});

// Reader
const reader=$('#reader'), readerContent=$('#readerContent');
$('#readerClose').addEventListener('click',()=>reader.style.display='none');
reader.addEventListener('click',e=>{if(e.target.classList.contains('reader-backdrop'))reader.style.display='none';});
async function openReader(url){
  setStatus('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–º —Å—Ç–∞—Ç–∏—è...');
  const prox=`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
  const res=await fetch(prox); const html=await res.text(); const doc=parseHTML(html);
  const ld=html.match(/<script[^>]*type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi);
  let articleText=null,dateText='';
  if(ld){for(let m of ld){try{const j=JSON.parse(m.match(/<script[^>]*>([\s\S]*?)<\/script>/i)[1]);
  if(j.articleBody){articleText=j.articleBody;dateText=j.datePublished||'';break;}}catch{}}}
  if(articleText){readerContent.innerHTML=`${dateText?`<div class='reader-date'>üïí ${dateText}</div>`:''}<p>${articleText}</p>`;
  reader.style.display='block';}
}

// –§–∏–ª—Ç—Ä–∏
document.querySelectorAll('.chip').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); applyDateFilter(b.dataset.filter);
}));
function applyDateFilter(f){
  const now=new Date();document.querySelectorAll('.card-row').forEach(c=>{
    const d=new Date(c.dataset.date);let s=true;
    if(f==='today')s=d.toDateString()===now.toDateString();
    if(f==='week')s=(now-d)/(1000*60*60*24)<=7;
    if(f==='month')s=(now-d)/(1000*60*60*24)<=31;
    c.style.display=s?'':'none';
  });
}

// –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
const catSel=$('#categorySelect');
function populateCategories(){
  const cats=new Set();document.querySelectorAll('.card-row[data-category]').forEach(c=>cats.add(c.dataset.category));
  catSel.innerHTML='<option value="all">–í—Å–∏—á–∫–∏</option>'+[...cats].map(c=>`<option>${c}</option>`).join('');
}
catSel.addEventListener('change',()=>{
  const sel=catSel.value;document.querySelectorAll('.card-row').forEach(c=>{
    c.style.display=(sel==='all'||c.dataset.category===sel)?'':'none';
  });
});
</script>
</body>
</html>