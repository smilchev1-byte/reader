<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Receipt Analyzer</title>
  <style>
    :root {
      --primary: #2563eb;
      --bg: #0b1220;
      --panel: #111a2e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --border: rgba(255,255,255,0.12);
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, #0b1220, #0b1220 40%, #070b14);
      color: var(--text);
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 24px 16px 60px;
    }
    h1 { margin: 0 0 6px; font-size: 26px; }
    .sub { color: var(--muted); margin-bottom: 16px; }
    .card {
      background: rgba(17,26,46,0.9);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-top: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    label { display:block; margin: 10px 0 6px; color: var(--muted); }
    input[type="text"], textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 80px; resize: vertical; }
    input[type="file"] {
      width: 100%;
      padding: 10px 0;
      color: var(--muted);
    }
    .row {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 14px;
    }
    @media (max-width: 820px) { .row { grid-template-columns: 1fr; } }

    button {
      margin-top: 12px;
      background: var(--primary);
      color: white;
      border: 0;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      font-size: 15px;
    }
    button:disabled { opacity: 0.65; cursor: not-allowed; }

    .error {
      display:none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(239,68,68,0.4);
      background: rgba(239,68,68,0.12);
      color: #fecaca;
      white-space: pre-wrap;
    }

    .loader {
      display:none;
      margin-top: 10px;
      color: var(--muted);
    }

    .preview img {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .category-card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-top: 12px;
      background: rgba(255,255,255,0.03);
    }
    .category-title {
      display:flex;
      align-items:center;
      justify-content: space-between;
      font-weight: 800;
      color: #dbeafe;
      margin-bottom: 8px;
    }
    .item-row {
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.10);
      color: #e5e7eb;
    }
    .item-row:last-child { border-bottom: 0; }
    .muted { color: var(--muted); }
    .tiny { font-size: 12px; color: var(--muted); margin-top: 10px; }
    code { background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 8px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Анализ на касова бележка</h1>
    <div class="sub">GitHub Pages (frontend) + Cloudflare Worker (backend). API ключът не е в браузъра.</div>

    <div class="card">
      <div class="row">
        <div>
          <label for="categories">Категории (разделени със запетая)</label>
          <input id="categories" type="text"
            value="Храна, Транспорт, Домакинство, Дрехи, Алкохол, Козметика, Други" />

          <label for="fileInput">Снимка на бележката</label>
          <input id="fileInput" type="file" accept="image/*" />

          <button id="analyzeBtn">Анализирай Бележката</button>

          <div id="loader" class="loader">Обработване... (може да отнеме 5–20 сек)</div>
          <div id="errorMsg" class="error"></div>

          <div class="tiny">
            Важно: Ако още не си, първо деплойни Worker и сложи URL-а му в <code>WORKER_URL</code> в кода.
          </div>
        </div>

        <div>
          <div class="preview card" style="margin-top:0;">
            <div class="muted" style="margin-bottom:8px;">Преглед:</div>
            <img id="imagePreview" alt="preview" />
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800; margin-bottom:8px;">Резултати</div>
      <div id="results"></div>
    </div>
  </div>

<script type="module">
  // 1) СМЕНИ ТОВА с твоя Cloudflare Worker URL:
  const WORKER_URL = "https://REPLACE-ME.workers.dev";

  const fileInput = document.getElementById("fileInput");
  const imagePreview = document.getElementById("imagePreview");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const loader = document.getElementById("loader");
  const resultsDiv = document.getElementById("results");
  const errorDiv = document.getElementById("errorMsg");
  const categoriesInput = document.getElementById("categories");

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    errorDiv.style.display = "none";
    resultsDiv.innerHTML = "";

    if (!file) return;

    const previewUrl = URL.createObjectURL(file);
    imagePreview.src = previewUrl;
  });

  analyzeBtn.addEventListener("click", async () => {
    errorDiv.style.display = "none";
    resultsDiv.innerHTML = "";

    const file = fileInput.files?.[0];
    const categories = String(categoriesInput.value || "").trim();

    if (!WORKER_URL.includes("workers.dev")) {
      showError("Смени WORKER_URL в кода с твоя Cloudflare Worker адрес.");
      return;
    }
    if (!categories) {
      showError("Моля, въведи категории.");
      return;
    }
    if (!file) {
      showError("Моля, избери снимка.");
      return;
    }

    analyzeBtn.disabled = true;
    loader.style.display = "block";

    try {
      const { base64, mimeType } = await fileToBase64(file);

      const payload = {
        categories,
        imageBase64: base64,
        mimeType
      };

      const resp = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await resp.text();
      let json;
      try { json = JSON.parse(text); } catch { json = null; }

      if (!resp.ok) {
        const msg = json?.error
          ? `${json.error}\n\nDetails:\n${JSON.stringify(json.details || json, null, 2)}`
          : `HTTP ${resp.status}\n\n${text}`;
        throw new Error(msg);
      }

      renderResults(json.data);
    } catch (err) {
      showError("Възникна грешка:\n" + (err?.message || String(err)));
    } finally {
      analyzeBtn.disabled = false;
      loader.style.display = "none";
    }
  });

  function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.style.display = "block";
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderResults(data) {
    if (!Array.isArray(data) || data.length === 0) {
      resultsDiv.innerHTML = "<div class='muted'>Няма върнати данни.</div>";
      return;
    }

    let html = "";
    let grandTotal = 0;

    for (const cat of data) {
      const items = Array.isArray(cat.items) ? cat.items : [];
      if (items.length === 0) continue;

      let catTotal = 0;
      let itemsHtml = "";

      for (const it of items) {
        const name = it?.name ?? "";
        const price = Number(it?.price ?? 0) || 0;
        catTotal += price;

        itemsHtml += `
          <div class="item-row">
            <span>${escapeHtml(name)}</span>
            <span>${price.toFixed(2)} лв.</span>
          </div>
        `;
      }

      grandTotal += catTotal;

      html += `
        <div class="category-card">
          <div class="category-title">
            <span>${escapeHtml(cat.category ?? "Категория")}</span>
            <span>${catTotal.toFixed(2)} лв.</span>
          </div>
          ${itemsHtml}
        </div>
      `;
    }

    html += `
      <div style="text-align:right; font-size:18px; font-weight:900; margin-top:14px; color:#bfdbfe;">
        ОБЩО: ${grandTotal.toFixed(2)} лв.
      </div>
    `;

    resultsDiv.innerHTML = html;
  }

  async function fileToBase64(file) {
    const mimeType = file.type || "image/jpeg";
    const buf = await file.arrayBuffer();
    const bytes = new Uint8Array(buf);

    // конвертира Uint8Array -> base64 без да слагаме data:image/...;base64,
    // защото Gemini иска само суров base64
    let binary = "";
    const chunkSize = 0x8000;
    for (let i = 0; i < bytes.length; i += chunkSize) {
      binary += String.fromCharCode(...bytes.subarray(i, i + chunkSize));
    }
    const base64 = btoa(binary);

    return { base64, mimeType };
  }
</script>
</body>
</html>
