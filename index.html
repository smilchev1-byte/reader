<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Receipt Analyzer</title>
    <style>
        :root {g
            --primary: #4285f4;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: var(--card);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 { text-align: center; color: var(--primary); margin-bottom: 1.5rem; }

        .input-group { margin-bottom: 1.5rem; }
        
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        input[type="file"] {
            width: 100%;
            padding: 10px;
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { background-color: #3367d6; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .preview-container {
            text-align: center;
            margin: 1rem 0;
            display: none;
        }

        .preview-container img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        #results { margin-top: 2rem; }

        .category-card {
            background: #f8f9fa;
            border-left: 5px solid var(--primary);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .category-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .error { 
            color: #d32f2f; 
            background: #fdecea; 
            padding: 10px; 
            border-radius: 4px;
            text-align: center; 
            margin-top: 10px; 
            display: none;
            word-wrap: break-word; 
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üßæ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ –ë–µ–ª–µ–∂–∫–∏</h1>

    <div class="input-group">
        <label for="categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏ —Å—ä—Å –∑–∞–ø–µ—Ç–∞—è):</label>
        <textarea id="categories" rows="2">–•—Ä–∞–Ω–∞, –ù–∞–ø–∏—Ç–∫–∏, –ë–∏—Ç, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –î—Ä–µ—Ö–∏, –î—Ä—É–≥–∏</textarea>
    </div>

    <div class="input-group">
        <label for="fileInput">–ò–∑–±–µ—Ä–∏ —Å–Ω–∏–º–∫–∞ –Ω–∞ –±–µ–ª–µ–∂–∫–∞:</label>
        <input type="file" id="fileInput" accept="image/*">
    </div>

    <div class="preview-container" id="previewContainer">
        <img id="imagePreview" src="" alt="Preview">
    </div>

    <button id="analyzeBtn" onclick="processReceipt()">–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π –ë–µ–ª–µ–∂–∫–∞—Ç–∞</button>
    
    <div id="loader" class="loader"></div>
    <div id="errorMsg" class="error"></div>
    
    <div id="results"></div>
</div>

<script type="module">
  const fileInput = document.getElementById('fileInput');
  const imagePreview = document.getElementById('imagePreview');
  const previewContainer = document.getElementById('previewContainer');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const loader = document.getElementById('loader');
  const resultsDiv = document.getElementById('results');
  const errorDiv = document.getElementById('errorMsg');

  fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        previewContainer.style.display = 'block';
        resultsDiv.innerHTML = '';
        errorDiv.style.display = 'none';
      }
      reader.readAsDataURL(file);
    }
  });

  window.processReceipt = async function() {
    const categories = document.getElementById('categories').value;
    const file = fileInput.files[0];

    errorDiv.style.display = 'none';
    if (!file) { showError("–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ —Å–Ω–∏–º–∫–∞."); return; }

    analyzeBtn.disabled = true;
    analyzeBtn.innerText = "–û–±—Ä–∞–±–æ—Ç–≤–∞–Ω–µ...";
    loader.style.display = 'block';
    resultsDiv.innerHTML = '';

    try {
      const form = new FormData();
      form.append("categories", categories);
      form.append("image", file);

      const resp = await fetch("http://localhost:3000/analyze", {
        method: "POST",
        body: form
      });

      const json = await resp.json();

      if (!resp.ok) {
        throw new Error(json.error || ("HTTP " + resp.status));
      }

      renderResults(json.data);
    } catch (error) {
      showError("–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞: " + error.message);
    } finally {
      analyzeBtn.disabled = false;
      analyzeBtn.innerText = "–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π –ë–µ–ª–µ–∂–∫–∞—Ç–∞";
      loader.style.display = 'none';
    }
  };

  function showError(msg) {
    errorDiv.innerText = msg;
    errorDiv.style.display = 'block';
  }

  function renderResults(data) {
    if (!data || data.length === 0) {
      resultsDiv.innerHTML = '<p>–ù–µ –±—è—Ö–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –¥–∞–Ω–Ω–∏.</p>';
      return;
    }

    let html = '';
    let grandTotal = 0;

    data.forEach(cat => {
      if (cat.items && cat.items.length > 0) {
        let catTotal = 0;
        let itemsHtml = '';

        cat.items.forEach(item => {
          const price = Number(item.price) || 0;
          catTotal += price;

          itemsHtml += `
            <div class="item-row">
              <span>${escapeHtml(item.name ?? "")}</span>
              <span>${price.toFixed(2)} –ª–≤.</span>
            </div>
          `;
        });

        grandTotal += catTotal;

        html += `
          <div class="category-card">
            <div class="category-title">
              ${escapeHtml(cat.category ?? "")}
              <span>${catTotal.toFixed(2)} –ª–≤.</span>
            </div>
            ${itemsHtml}
          </div>
        `;
      }
    });

    html += `
      <div style="text-align: right; font-size: 1.5rem; font-weight: bold; margin-top: 20px; color: var(--primary);">
        –û–ë–©–û: ${grandTotal.toFixed(2)} –ª–≤.
      </div>
    `;

    resultsDiv.innerHTML = html;
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
</script>

</body>
</html>
