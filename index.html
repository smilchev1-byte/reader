<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Извличане на статии (gtag-feed-statia*)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:1.5rem; color:#111; background:#fafafa}
    header{margin-bottom:1rem}
    input[type=url]{width:100%; max-width:780px; padding:.6rem .8rem; font-size:1rem}
    button{padding:.6rem .9rem; font-size:1rem; cursor:pointer; margin-top:.5rem}
    .status{margin:.75rem 0; color:#555}
    .results{margin-top:1rem}
    .item{background:#fff; border:1px solid #e5e5e5; border-radius:.5rem; padding:.75rem .9rem; margin:.5rem 0}
    .item a{word-break:break-all; text-decoration:none}
    .item small{display:block; color:#666; margin-top:.25rem}
    .error{color:#b00020}
  </style>
</head>
<body>
  <header>
    <h1>Извади линкове и текст от <code>gtag-feed-statia*</code></h1>
    <p>Въведи URL на страница от новинарски сайт:</p>
    <input id="url" type="url" placeholder="https://примерен-сайт.bg/новини" required>
    <br>
    <button id="go">Извлечи</button>
    <div id="status" class="status"></div>
  </header>

  <section id="results" class="results"></section>

  <script>
    const $ = s => document.querySelector(s);
    const statusEl = $("#status");
    const resultsEl = $("#results");
    const urlInput = $("#url");
    const goBtn = $("#go");

    function setStatus(msg, isError=false){
      statusEl.textContent = msg || "";
      statusEl.className = "status" + (isError ? " error" : "");
    }

    function absolutize(href, base){
      try { return new URL(href, base).toString(); }
      catch { return href; }
    }

    async function fetchRawHTML(targetURL){
      // Използваме AllOrigins за да избегнем CORS
      const api = "https://api.allorigins.win/raw?url=" + encodeURIComponent(targetURL);
      const res = await fetch(api, {cache: "no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    }

    function extractLinks(html, baseHref){
      const dom = new DOMParser().parseFromString(html, "text/html");

      // Търсим <a> с клас, който съдържа 'gtag-feed-statia'
      // (не изискваме задължително 'flex-grow-1', за да обхванем и леко различни варианти)
      const anchors = dom.querySelectorAll('a[class*="gtag-feed-statia"]');

      // Филтър: ако желаеш строго и 'flex-grow-1', разкоментирай реда отдолу:
      // const anchors = [...dom.querySelectorAll('a[class*="gtag-feed-statia"]')].filter(a => a.classList.contains('flex-grow-1'));

      return [...anchors].map(a => ({
        href: absolutize(a.getAttribute("href") || "", baseHref),
        text: (a.textContent || "").trim(),
        title: (a.getAttribute("title") || "").trim()
      })).filter(x => x.href);
    }

    function render(items){
      resultsEl.innerHTML = "";
      if(items.length === 0){
        resultsEl.innerHTML = "<p>Нищо не е намерено за <code>gtag-feed-statia*</code>.</p>";
        return;
      }
      const frag = document.createDocumentFragment();
      items.forEach((it, i) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <strong>${i+1}.</strong>
          <a href="${it.href}" target="_blank" rel="noopener">${it.text || it.title || it.href}</a>
          <small>${it.title ? ("title: " + it.title + " · ") : ""}${it.href}</small>
        `;
        frag.appendChild(div);
      });
      resultsEl.appendChild(frag);
    }

    async function run(){
      const target = (urlInput.value || "").trim();
      if(!target){ setStatus("Моля, въведи валиден URL.", true); return; }
      setStatus("⏳ Зареждам HTML…");
      resultsEl.innerHTML = "";

      try{
        const html = await fetchRawHTML(target);
        setStatus("✅ HTML зареден. Парсирам…");
        const items = extractLinks(html, target);
        render(items);
        setStatus("Готово.");
      }catch(err){
        console.error(err);
        setStatus("❌ Грешка при зареждане/парсване: " + err.message, true);
      }
    }

    goBtn.addEventListener("click", run);
    urlInput.addEventListener("keydown", e => { if(e.key === "Enter") run(); });
  </script>
</body>
</html>
